{% extends 'base.html' %}

{% block contenido %}
	<div class="max-w-8xl mx-auto bg-white p-6 rounded-lg shadow-lg">
		<h1 class="text-3xl font-bell mb-6 text-center">{{ titulo }}</h1>
		<form method="POST" action="{{ action_save }}">
			{% csrf_token %}

			<!-- Selector de residente -->
			<div class="mb-6">
				<label for="residente" class="block text-lg font-bell mb-2 text-gray-700">Seleccione el
					Residente:</label>
				<select class="w-full border border-gray-300 p-2 rounded-md" id="id_residente" required>
					<option selected disabled value="">Seleccione un Residente</option>
					{% for residente in residentes %}
						<option value="{{ residente.id }}">{{ residente.nombre }} - {{ residente.cedula }}</option>
					{% endfor %}
				</select>
			</div>

			<!-- Campo Descripción -->
			<div class="mb-6">
				<label for="descripcion" class="block text-lg font-bell mb-2 text-gray-700">Descripción:</label>
				<input class="w-full border border-gray-300 p-2 rounded-md" type="text"
				       id="id_descripcion" required>
			</div>

			<!-- Tabla de miembros de la familia -->
			<div class="overflow-x-auto">
				<table class="w-full text-left table-auto border-collapse bg-white shadow-lg rounded-lg" id="familia">
					<thead class="text-center">
					<tr class="bg-gray-300">
						<th class="p-3 border">Nombre</th>
						<th class="p-3 border">Cédula</th>
						<th class="p-3 border">Sexo</th>
						<th class="p-3 border">Parentesco</th>
						<th class="p-3 border">Fecha de Nacimiento</th>
						<th class="p-3 border">Acción</th>
					</tr>
					</thead>
					<tbody>

					</tbody>
					<tr class="bg-gray-300">
						<td class="p-3 border">
							<input class="" type="text" id="nombre" placeholder="Nombre" required>
						</td>
						<td class="p-3 border">
							<input class="form-control" type="text" id="cedula" placeholder="Cédula" required>
						</td>
						<td class="p-3 border">
							<select class="form-control" id="sexo" required>
								<option value="">Sexo</option>
								<option value="Masculino">Masculino</option>
								<option value="Femenino">Femenino</option>
							</select>
						</td>
						<td class="p-3 border">
							<select class="form-control" id="parentesco" required>
								<option value="">Parentesco</option>
								<option value="Hermano">Hermano</option>
								<option value="Hermana">Hermana</option>
								<option value="Padre">Padre</option>
								<option value="Madre">Madre</option>
								<option value="Abuelo">Abuelo</option>
								<option value="Abuela">Abuela</option>
								<option value="Conyuge">Conyuge</option>
								<option value="Hijo">Hijo</option>
								<option value="Hija">Hija</option>
							</select>
						</td>
						<td class="p-3 border">
							<input class="form-control" type="date" id="fecha-nacimiento" required>
						</td>
						<td class="p-3 border flex justify-center h-full">
							<a class="bg-blue-500 text-white py-2 px-4 rounded-md shadow-md hover:bg-blue-600
							focus:outline-none" onclick="agregarPersona()">Agregar
							</a>
						</td>
					</tr>
				</table>

				<p class="mt-4 text-lg font-bold">Total de miembros: <span
						id="contadorMiembros"></span></p>
			</div>
			<!-- Botones de acción -->
			<div class="flex justify-between mt-6 space-x-2">
				<a href="{{ cancel_url }}"
				   class="w-1/2 bg-red-500 text-white py-2 rounded-md shadow-md hover:bg-red-600 focus:outline-none text-center">Cancelar</a>
				<button id="add-row" type="button"
				        class="w-1/2 bg-blue-500 text-white py-2 rounded-md shadow-md hover:bg-blue-600 focus:outline-none">
					Agregar otro miembro
				</button>
				<a class="w-1/2 bg-green-500 text-white py-2 rounded-md shadow-md hover:bg-green-600
				focus:outline-none text-center" onclick="comsumirApi()">
					Guardar Familia
				</a>
			</div>
		</form>
	</div>

	<script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        // Definimos variables
        const residente = {
            id: 0,
            descripcion: ''
        }
        const listaFamilia = [] // Detalles de la transacción
        let contFamilia = 0
        document.getElementById("contadorMiembros").textContent = contFamilia

        function comsumirApi() {
            residente['id'] = document.getElementById('id_residente').value
            residente['descripcion'] = document.getElementById('id_descripcion').value
            if (residente.descripcion.length > 50) {
                // La longitud de la descripción es mayor a 50
                console.log('La descripción es demasiado larga.');
                alert('La descripción es demasiado larga.')
            } else {
                console.log('La descripción es aceptable.');
                fetch('http://localhost:8000/api/crear_familia/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify(
                        {residente, listaFamilia}
                    )
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la red');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Objeto creado:', data);
                        console.log(data);
                    })
                    .catch(error => {
                        console.error('Error al crear el objeto:', error);
                    });
            }

        }

        function agregarPersona() {
            const nombre = document.getElementById("nombre").value;
            const cedula = document.getElementById("cedula").value;
            const sexo = document.getElementById("sexo").value;
            const parentesco = document.getElementById("parentesco").value;
            const fechaNacimiento = document.getElementById("fecha-nacimiento").value;

            if (nombre && cedula && sexo && parentesco && fechaNacimiento) {
                const persona = {
                    nombre,
                    cedula,
                    sexo,
                    parentesco,
                    fechaNacimiento
                }
                fetch('http://localhost:8000/api/validar_persona_familia/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify(
                        {persona}
                    )
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la red');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(data.mensaje);
                        if (data.mensaje === 'La cedula es ecuatoriana') {
                            listaFamilia.push(persona);
                            actualizarTabla()
                            // limpiar campos
                            document.getElementById("nombre").value = ''
                            document.getElementById("cedula").value = ''
                            document.getElementById("sexo").value = ''
                            document.getElementById("parentesco").value = ''
                            document.getElementById("fecha-nacimiento").value = ''
                            contFamilia += 1
                            document.getElementById("contadorMiembros").textContent = contFamilia
                        } else {
                            alert(data.mensaje)
                        }
                    })
                    .catch(error => {
                        console.error('Error al crear el objeto:', error);
                    });

            } else {
                alert('Debe insertar todos los datos.')
            }
        }

        function eliminarPersona(index) {
            listaFamilia.splice(index, 1) // elimiar la persona de la lista/ tabla
            actualizarTabla()
            contFamilia -= 1
            document.getElementById("contadorMiembros").textContent = contFamilia
        }

        function actualizarTabla() {
            console.log(listaFamilia)
            const cuerpoTabla = document.getElementById('familia').getElementsByTagName('tbody')[0]
            cuerpoTabla.innerHTML = '' // limpiamos el contenido de la tabla, por si contiene algo

            // agregar personas a la tabla
            listaFamilia.forEach((persona, index) => {
                const nuevaFila = cuerpoTabla.insertRow();
                nuevaFila.innerHTML = `
                <td class="p-3">${persona.nombre}</td>
                    <td class="p-3">${persona.cedula}</td>
                    <td class="p-3">${persona.sexo}</td>
                    <td class="p-3">${persona.parentesco}</td>
                    <td class="p-3">${persona.fechaNacimiento}</td>
                    <td class="p-3 flex justify-center items-center">
                        <button class="bg-red-500 px-4 py-2 rounded-lg text-white" onclick="eliminarPersona(${index})">
                        Eliminar</button>
                    </td>`
            })
        }
	</script>
{% endblock %}